<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Generalized Structured Component Analysis - Visualization tool</title>
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/dataTables.bootstrap4.css">
    <link rel="stylesheet" href="css/ionicons.min.css">
    <link rel="stylesheet" href="css/AdminLTE.min.css">
    <link rel="stylesheet" href="css/skins/_all-skins.min.css">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">
</head>
<body class="skin-blue layout-top-nav">
<div class="wrapper">
    <header class="main-header">
        <nav class="navbar navbar-static-top">
            <div class="container">
                <div class="navbar-header">
                    <a href="index.html" class="navbar-brand"><b>GSCA</b>Viz</a>
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                            data-target="#navbar-collapse">
                        <i class="fa fa-bars"></i>
                    </button>
                </div>

                <!-- Collect the nav links, forms, and other content for toggling -->
                <div class="collapse navbar-collapse pull-left" id="navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li class="active"><a href="#">Step 1: Data Prep <span class="sr-only">(current)</span></a></li>
                        <li><a href="#">Step 2: Model Specs</a></li>
                        <li><a href="#">Step 3: Parameter Estimation</a></li>
                        <li><a href="#">Step 4: Model Evaluation</a></li>

                    </ul>
                    <form class="navbar-form navbar-left" role="search">
                        <div class="form-group">
                            <input type="text" class="form-control" id="navbar-search-input" placeholder="Search">
                        </div>
                    </form>
                </div>
                <!-- /.navbar-collapse -->
                <!-- Navbar Right Menu -->
                <div class="navbar-custom-menu">
                    <ul class="nav navbar-nav">
                        <!-- Messages: style can be found in dropdown.less-->
                        <li class="dropdown messages-menu">
                            <!-- Menu toggle button -->
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                <i class="fa fa-envelope-o"></i>
                                <span class="label label-success">4</span>
                            </a>

                        </li>
                        <!-- /.messages-menu -->

                        <!-- Notifications Menu -->
                        <li class="dropdown notifications-menu">
                            <!-- Menu toggle button -->
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                <i class="fa fa-bell-o"></i>
                                <span class="label label-warning">10</span>
                            </a>
                            <ul class="dropdown-menu">
                                <li class="header">You have 10 notifications</li>
                                <li>
                                    <!-- Inner Menu: contains the notifications -->
                                    <ul class="menu">
                                        <li><!-- start notification -->
                                            <a href="#">
                                                <i class="fa fa-users text-aqua"></i> 5 new members joined today
                                            </a>
                                        </li>
                                        <!-- end notification -->
                                    </ul>
                                </li>
                                <li class="footer"><a href="#">View all</a></li>
                            </ul>
                        </li>
                        <!-- Tasks Menu -->
                        <li class="dropdown tasks-menu">
                            <!-- Menu Toggle Button -->
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                <i class="fa fa-flag-o"></i>
                                <span class="label label-danger">9</span>
                            </a>
                            <ul class="dropdown-menu">
                                <li class="header">You have 9 tasks</li>
                                <li>
                                    <!-- Inner menu: contains the tasks -->
                                    <ul class="menu">
                                        <li><!-- Task item -->
                                            <a href="#">
                                                <!-- Task title and progress text -->
                                                <h3>
                                                    Design some buttons
                                                    <small class="pull-right">20%</small>
                                                </h3>
                                                <!-- The progress bar -->
                                                <div class="progress xs">
                                                    <!-- Change the css width attribute to simulate progress -->
                                                    <div class="progress-bar progress-bar-aqua" style="width: 20%"
                                                         role="progressbar" aria-valuenow="20" aria-valuemin="0"
                                                         aria-valuemax="100">
                                                        <span class="sr-only">20% Complete</span>
                                                    </div>
                                                </div>
                                            </a>
                                        </li>
                                        <!-- end task item -->
                                    </ul>
                                </li>
                                <li class="footer">
                                    <a href="#">View all tasks</a>
                                </li>
                            </ul>
                        </li>
                        <!-- User Account Menu -->
                        <li class="dropdown user user-menu">

                            <ul class="dropdown-menu">

                                <!-- Menu Body -->
                                <li class="user-body">
                                    <div class="row">
                                        <div class="col-xs-4 text-center">
                                            <a href="#">Followers</a>
                                        </div>
                                        <div class="col-xs-4 text-center">
                                            <a href="#">Sales</a>
                                        </div>
                                        <div class="col-xs-4 text-center">
                                            <a href="#">Friends</a>
                                        </div>
                                    </div>
                                    <!-- /.row -->
                                </li>
                                <!-- Menu Footer-->
                                <li class="user-footer">
                                    <div class="pull-left">
                                        <a href="#" class="btn btn-default btn-flat">Profile</a>
                                    </div>
                                    <div class="pull-right">
                                        <a href="#" class="btn btn-default btn-flat">Sign out</a>
                                    </div>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
                <!-- /.navbar-custom-menu -->
            </div>
            <!-- /.container-fluid -->
        </nav>
    </header>
    <!-- Full Width Column -->
    <div class="content-wrapper">
        <div class="container">
            <!-- Content Header (Page header) -->
            <section class="content-header">
                <h1>
                    Generalized Structured Component Analysis
                    <small>Version 1.0</small>
                </h1>
                <ol class="breadcrumb">
                    <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
                    <li><a href="#">Layout</a></li>
                    <li class="active">Top Navigation</li>
                </ol>
            </section>

            <!-- Main content -->
            <section class="content">
                <div class="row" id="dataPreps">
                    <div class="col-12">
                        <div class="box box-info">
                            <div class="box-header with-border">
                                <h3 class="box-title">Data Preperation</h3>
                                <div class="box-tools pull-right">
                                    <button type="button" class="btn btn-box-tool" data-widget="collapse"><i
                                            class="fa fa-minus"></i>
                                    </button>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-box-tool dropdown-toggle"
                                                data-toggle="dropdown">
                                            <i class="fa fa-wrench"></i></button>
                                        <ul class="dropdown-menu" role="menu">
                                            <li><a href="#">Action</a></li>
                                            <li><a href="#">Another action</a></li>
                                            <li><a href="#">Something else here</a></li>
                                            <li class="divider"></li>
                                            <li><a href="#">Separated link</a></li>
                                        </ul>
                                    </div>
                                    <button type="button" class="btn btn-box-tool" data-widget="remove"><i
                                            class="fa fa-times"></i></button>
                                </div>
                            </div>
                            <div class="box-body">
                                <div class="form-group">
                                    <label for="uploader">File input</label>
                                    <input type="file" id="uploader">

                                    <p class="help-block">Please upload your csv file here.</p>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-primary progress-bar-striped"
                                         role="progressbar" id="progressPrep" aria-valuenow="40" aria-valuemin="0"
                                         aria-valuemax="100" style="width: 40%">
                                        <span class="sr-only">40% Complete (success)</span>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="box box-info">
                        <div class="box-header with-border">
                            <h3 class="box-title">Data Sample</h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i
                                        class="fa fa-minus"></i>
                                </button>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-box-tool dropdown-toggle"
                                            data-toggle="dropdown">
                                        <i class="fa fa-wrench"></i></button>
                                    <ul class="dropdown-menu" role="menu">
                                        <li><a href="#">Action</a></li>
                                        <li><a href="#">Another action</a></li>
                                        <li><a href="#">Something else here</a></li>
                                        <li class="divider"></li>
                                        <li><a href="#">Separated link</a></li>
                                    </ul>
                                </div>
                                <button type="button" class="btn btn-box-tool" data-widget="remove"><i
                                        class="fa fa-times"></i></button>
                            </div>
                        </div>
                        <div class="box-body">
                            <div class="col-md-12" style="overflow: auto" id="tbl_container">
                            </div>
                        </div>

                    </div>
                </div>
                <!-- /.box -->

                <!--                Model specifications-->
                <div class="row">
                    <div class="box box-info">
                        <div class="box-header with-border">
                            <h3 class="box-title">Model specification</h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i
                                        class="fa fa-minus"></i>
                                </button>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-box-tool dropdown-toggle"
                                            data-toggle="dropdown">
                                        <i class="fa fa-wrench"></i></button>
                                    <ul class="dropdown-menu" role="menu">
                                        <li><a href="#">Action</a></li>
                                        <li><a href="#">Another action</a></li>
                                        <li><a href="#">Something else here</a></li>
                                        <li class="divider"></li>
                                        <li><a href="#">Separated link</a></li>
                                    </ul>
                                </div>
                                <button type="button" class="btn btn-box-tool" data-widget="remove"><i
                                        class="fa fa-times"></i></button>
                            </div>
                        </div>
                        <div class="box-body">
                            <div class="col-md-6" style="overflow: auto">
                                <div class="form-group">
                                    <label for="myModel">Input your model:</label>
                                    <textarea class="form-control" rows="15" id="myModel"></textarea>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-warning" id="btnAnalyzeModel">Analyze the
                                        model
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6" style="overflow: auto">
                                <div class="box box-info">
                                    <div class="box-header">
                                        <h3 class="box-title">Examples</h3>
                                        <div class="box-tools pull-right">
                                            <button type="button" id="clipboardCopy" class="btn btn-box-tool"><i
                                                    class="fa fa-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="box-body" id="sampleModel">
                                        <p class="text-success"># Measurement model</p>
                                        <p>OP =~ cei1 + cei2 + cei3</p>
                                        <p> OI =~ ma1 + ma2 + ma3</p>
                                        <p>AC_J =~ orgcmt1 + orgcmt2 + orgcmt3</p>
                                        <p>AC_L =~ orgcmt5 + orgcmt6 + orgcmt8</p>
                                        <p class="text-success"># Structural model</p>
                                        <p>OI ~ OP</p>
                                        <p>AC_J ~ OI</p>
                                        <p>AC_L ~ OI</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </section>
            <!-- /.content -->
        </div>
        <!-- /.container -->
    </div>
    <!-- /.content-wrapper -->
    <footer class="main-footer">
        <div class="container">
            <div class="pull-right hidden-xs">
                <b>Version</b> 2.4.13
            </div>
            <strong>Copyright &copy; 2014-2019 <a href="https://adminlte.io">AdminLTE</a>.</strong> All rights
            reserved.
        </div>
        <!-- /.container -->
    </footer>
</div>
<!-- ./wrapper -->

</body>
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/jquery.slimscroll.min.js"></script>
<script src="js/jquery.dataTables.js"></script>
<script src="js/dataTables.bootstrap4.js"></script>
<script src="js/fastclick.js"></script>
<script src="js/adminlte.min.js"></script>
<script src="js/underscore-min.js"></script>
<script src="js/jstat.min.js"></script>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/7.1.0/math.min.js"></script>
<script>

    class DataTablePrep {
        constructor() {
            this.jsonData = {};
            this.table = "";
            this.result = {};
            this.debug = false;
        }

        init(json) {
            this.jsonData = json;
            return this;
        }

        create2DarrayOfValue(row, col, val) {
            let arr = [];
            if (row === 1) {
                for (let j = 0; j < col; j++) {
                    arr.push(val)
                }
            } else {
                for (let i = 0; i < row; i++) {
                    let _row = [];
                    for (let j = 0; j < col; j++) {
                        _row.push(val)
                    }
                    arr.push(_row)
                }
            }

            return arr;
        }

        parseData(model) {
            let data = this.jsonData;
            let result = {};
            let temp = {};
            let colnames = Object.keys(data[0]);
            let splitLines = model.split('\n');
            for (let t = 0; t < splitLines.length; t++) {
                if (splitLines[t].startsWith("#") || splitLines[t].length === 0) {
                    //First remove data
                    if (this.debug) {
                        console.log(`Comment removed: ${splitLines[t]}`)
                    }
                    splitLines.splice(t, 1);
                    t--;
                }
            }
            temp.measurement = {};
            for (let t = 0; t < splitLines.length; t++) {
                if (splitLines[t].indexOf("=~") >= 0) {
                    let sp = splitLines[t].split("=~");
                    if (temp.measurement.hasOwnProperty(sp[0])) {
                        console.log(`Duplicate latent variable ${sp[0]}`)
                    } else {
                        temp.measurement[sp[0]] = sp[1];
                        splitLines.splice(t, 1);
                        t--;
                    }
                }
            }


            //Extract latent variable
            temp.latent = Object.keys(temp.measurement);
            temp.indicators = [];
            //Extract indicator

            temp.latent.forEach(key => {
                let _indicators = temp.measurement[key].split("+");
                temp.indicators = _.union(temp.indicators, _indicators)
            });
            //Check if indicators do not match columns name
            let indicatorUnmatch = _.difference(temp.indicators, colnames);
            if (indicatorUnmatch.length > 0) {
                if (this.debug) {
                    console.log(`Indicators does not match in data ${indicatorUnmatch.join(", ")}`)
                }
            }
            result.W00 = this.create2DarrayOfValue(temp.indicators.length, temp.latent.length, 0);
            //Update values in W00
            temp.latent.forEach((value, index) => {
                let _indicators = temp.measurement[value].split("+");
                _indicators.forEach((val2) => {
                    let rowIndex = temp.indicators.indexOf(val2);
                    result.W00[rowIndex][index] = 99;
                })
            });

            result.C00 = math.transpose(result.W00);


            //Construct B00
            temp.structuralmodel = {};
            for (let t = 0; t < splitLines.length; t++) {
                if (splitLines[t].indexOf("~") >= 0) {
                    let sp = splitLines[t].split("~");
                    if (temp.structuralmodel.hasOwnProperty(sp[0])) {
                        console.log(`Duplicate latent variable ${sp[0]}`)
                    } else {
                        temp.structuralmodel[sp[0]] = sp[1];
                        splitLines.splice(t, 1);
                        t--;
                    }
                }
            }
            result.B00 = this.create2DarrayOfValue(temp.latent.length, temp.latent.length, 0);
            for (let key of Object.keys(temp.structuralmodel)) {
                let c = temp.latent.indexOf(key);
                let r = temp.latent.indexOf(temp.structuralmodel[key]);
                result.B00[r][c] = 99;
            }

            //Process return data
            result.data = this.create2DarrayOfValue(data.length, temp.indicators.length, 0);
            data.forEach(function (d, i) {
                temp.indicators.forEach((val, id) => {
                    result.data[i][id] = +d[val];
                })
            });
            result.latent = temp.latent;
            result.indicators = temp.indicators;
            this.result = result;
            return this;
        }

        populateData() {
            // Reset table
            $('#tbl_container').empty();

            // Extract column names
            let colNames = Object.keys(this.jsonData[0]);
            let cols = "";
            // Populate cols
            colNames.forEach(col => {
                cols += "<th class='sorting_asc' tabindex='0' aria-controls='table_content' rowspan='1' colspan='1' aria-sort='ascending'>" + col + "</th>";
            })

            let tblheader = "<thead><tr role='row'>" + cols + "</tr></thead>";
            let tblrows = "";
            const _sliceLenght = this.jsonData.length < 1000 ? this.jsonData.length : 1000;
            let subsetData = this.jsonData.slice(0, _sliceLenght);
            subsetData.forEach((row, index) => {
                let _col = ``;
                for (let key in row) {
                    _col += `<td>${row[key]}</td>`
                }


                let _class = index % 2 === 0 ? "even" : "odd";
                tblrows += `<tr role='row' class=${_class}>${_col}</tr>`;

            });
            this.table = "<table id='table_content' class='table table-bordered table-striped dataTable overflow-auto' role='grid'>" + tblheader + tblrows + "</table>";
            return this;
        }

        display() {
            $('#tbl_container').append(this.table);
            $("#table_content").DataTable();
        }
    }

    class GESCA {
        constructor() {
            this.z0 = null;
            this.W00 = null;
            this.C00 = null;
            this.B00 = null;
            this.nbt = 100;
            this.itmax = 100;
            this.ceps = 0.00001;
            this.moption = 0;
            this.missingvalue = null;
            this.output = {};
        }

        // params = z0, group_var, W00, C00, B00,
        //                      loadtype = matrix(1,1,ncol(W00)), nbt = 100, itmax = 100,
        //                      ceps = 0.00001, moption = 0, missingvalue = NULL
        init(params) {
            this.z0 = params.z0;
            this.W00 = params.W00;
            this.C00 = params.C00;
            this.B00 = params.B00;
            this.loadtype = params.loadtype;
            this.nbt = params.nbt;
            this.itmax = params.itmax;
            this.ceps = params.ceps;
            this.moption = params.moption;
            this.missingvalue = params.missingvalue;
            this.group_var = params.group_var;
            console.log(this);
            return this;
        }

        modelAnalyzer() {
            // Missing values
            // if(this.moption===1){
            //process missing values
            // }
            let dimensions = jStat(this.z0).dimensions();
            let number_of_observations = dimensions.rows;
            let number_of_variables = dimensions.cols;
            let number_of_groups = 1;//Fix later
            let number_of_observation_per_group = this.create1Darray(number_of_groups, 0);
            for (let g = 0; g < number_of_groups; g++) {
                number_of_observation_per_group[g] = number_of_observations;
            }

            let case_index = jStat.zeros(number_of_groups, 2);
            let _from = -1;
            for (let ng = 0; ng < number_of_groups; ng++) {
                let _start = _from + 1;
                let _end = _from + number_of_observation_per_group[ng];
                case_index[ng][0] = _start;
                case_index[ng][1] = _end;
            }
            //
            let number_of_latent_vars = this.loadtype.length;
            let total_vars_latent = number_of_latent_vars + number_of_variables;
            // //We skip reflective
            //
            let A00 = math.concat(this.C00, this.B00);
            // console.log(A00)
            let _I = math.identity(number_of_variables)._data;
            let V00 = math.concat(_I, this.W00);
            let Wi = JSON.parse(JSON.stringify(this.W00));
            let Ai = JSON.parse(JSON.stringify(A00));
            //
            // //Calculate index
            let windex0 = [];
            let aindex0 = [];
            let _W00 = math.flatten(math.transpose(this.W00));
            _W00.forEach((_d, _i) => {
                if (_d === 99) {
                    windex0.push(_i);
                }
            })
            let _A00 = math.flatten(math.transpose(A00));
            _A00.forEach((_d, _i) => {
                if (_d === 99) {
                    aindex0.push(_i);
                }
            })
            // //End of index calculation
            //

            let W0 = jStat.zeros(number_of_groups * number_of_variables, number_of_groups * number_of_latent_vars);
            let A0 = jStat.zeros(number_of_groups * number_of_latent_vars, total_vars_latent);
            let V0 = jStat.zeros(number_of_groups * number_of_variables, number_of_groups * total_vars_latent);
            //
            let W = JSON.parse(JSON.stringify(W0));
            let A = JSON.parse(JSON.stringify(A0));
            let V = JSON.parse(JSON.stringify(V0));
            let kk = -1, ss = -1, ll = -1;
            for (let j = 0; j < number_of_groups; j++) {
                let k = kk + 1;
                kk += number_of_variables;
                let s = ss + 1;
                ss += number_of_latent_vars;
                let l = ll + 1;
                ll += total_vars_latent;

                W0 = this.cloneArray(this.W00, W0, k, s);
                windex0.forEach(d => {
                    let r = d % number_of_variables;
                    let c = math.floor(d / number_of_variables);
                    Wi[r][c] = math.random();
                })
                W = this.cloneArray(Wi, W, k, s);
                A0 = this.cloneArray(A00, A0, s, 0);

                aindex0.forEach(d => {
                    let r = d % jStat(A).dimensions().rows;
                    let c = math.floor(d / jStat(A).dimensions().rows);
                    Ai[r][c] = math.random();
                })

                console.log("Done...")
                A = this.cloneArray(Ai, A, s, 0);
                V0 = this.cloneArray(V00, V0, k, l);
                let I = jStat.identity(number_of_variables);
                let _WI = math.concat(I, Wi);
                V = this.cloneArray(_WI, V, k, l);
                console.log("Phew...")
            }
            let I = jStat.zeros(total_vars_latent * number_of_groups, total_vars_latent);
            kk = -1;
            for (let g = 0; g < number_of_groups; g++) {
                let k = kk + 1;
                kk += total_vars_latent;
                let _I = jStat.identity(total_vars_latent);
                I = this.cloneArray(_I, I, k, 0);

            }
            let constrainmatrix = this.generateConstraintMatrix(A0);
            let PHT = constrainmatrix.PHT;
            let num_nzct = constrainmatrix.num_nzct;
            let num_const = constrainmatrix.num_const;

            // Start Bootstrap
            let num_nnz_W00 = math.flatten(this.W00).filter(d => d !== 0).length;
            let num_nnz_C00 = math.flatten(this.C00).filter(d => d !== 0).length;
            let num_nnz_B00 = math.flatten(this.B00).filter(d => d !== 0).length;

            let vec_FIT = jStat.zeros(this.nbt, 1);
            let vec_FIT_m = jStat.zeros(this.nbt, 1);
            let vec_FIT_s = jStat.zeros(this.nbt, 1);
            let vec_AFIT = jStat.zeros(this.nbt, 1);
            let vec_GFI = jStat.zeros(this.nbt, 1);
            let vec_SRMR = jStat.zeros(this.nbt, 1);

            let MatW = jStat.zeros(this.nbt, num_nnz_W00 * number_of_groups);
            let Matload = jStat.zeros(this.nbt, num_nnz_C00 * number_of_groups);
            let Matbeta = jStat.zeros(this.nbt, num_nnz_B00 * number_of_groups);
            let Matsmc = jStat.zeros(this.nbt, num_nnz_C00 * number_of_groups);
            let MatcorF = jStat.zeros(this.nbt, Math.pow(number_of_latent_vars, 2) * number_of_groups);

            let MatTE_S = [];
            let MatID_S = [];
            let MatTE_M = [];
            let MatID_M = [];
            let Z;
            let WR, Cr, Br, samplesizes, FIT, FIT_S, FIT_M, AFIT, GFI, SRMR, R2, AVE, Alpha, rho, LV_MEAN, LV_VAR,
                corr_corres, Dimension, latencorr, TE_S, ID_S, TE_M, ID_M, mW, mC, mB, mSMC, mCF, lb, ub;

            for (let b = 0; b <= this.nbt; b++) {
                if (b === 0) {
                    if (this.moption > 1) {

                    } else {
                        this.output.bootsample = this.bootsample(this.z0, case_index, number_of_variables, number_of_observation_per_group, number_of_groups, b, number_of_observations);
                        Z = JSON.parse(JSON.stringify(this.output.bootsample.Z));
                    }
                } else {
                    this.output.bootsample = this.bootsample(this.z0, case_index, number_of_variables, number_of_observation_per_group, number_of_groups, b, number_of_observations);
                    Z = JSON.parse(JSON.stringify(this.output.bootsample.Z));
                }


                if (b === 0) {
                    if (this.moption === 3) {
                    } else {
                        this.output.RESULT = this.alternativeLeastSquareAlgorithm(Z, W0, A0, W, A, V, I, PHT, number_of_variables, number_of_latent_vars, number_of_groups, this.itmax, this.ceps);
                    }
                } else {
                    this.output.RESULT = this.alternativeLeastSquareAlgorithm(Z, W0, A0, W, A, V, I, PHT, number_of_variables, number_of_latent_vars, number_of_groups, this.itmax, this.ceps);
                }
                let it = this.output.RESULT.it;
                let imp = this.output.RESULT.imp;
                let Gamma = JSON.parse(JSON.stringify(this.output.RESULT.Gamma));
                let Psi = JSON.parse(JSON.stringify(this.output.RESULT.Psi));
                let f0 = this.output.RESULT.f0;
                A = JSON.parse(JSON.stringify(this.output.RESULT.A));
                let corF = math.multiply(math.transpose(this.output.RESULT.Gamma), this.output.RESULT.Gamma);
                let CR = math.transpose(jStat.col(A, jStat.arange(number_of_variables)));
                let BR = math.transpose(jStat.col(A, jStat.arange(number_of_variables, total_vars_latent)));
                let DF = number_of_observations * number_of_variables;

                let npw = math.flatten(W0).filter(d => d === 99).length;
                let dpht = math.diag(PHT);
                let cnzt;
                if (num_nzct === 0) {
                    cnzt = dpht.filter(d => d === 1).length;
                } else {
                    cnzt = num_nzct + dpht.filter(d => d === 1).length;
                }
                let NPAR = cnzt + npw;

                let Fit = 1 - f0 / (math.sum(math.diag(math.multiply(math.transpose(Psi), Psi))));
                let dif_m = math.subtract(jStat.col(Psi, jStat.arange(number_of_variables)), math.multiply(Gamma, math.transpose(CR)));
                let dif_s = math.subtract(jStat.col(Psi, jStat.arange(number_of_variables, total_vars_latent)), math.multiply(Gamma, math.transpose(BR)));
                let Fit_m = 1 - math.sum(math.diag(math.multiply(math.transpose(dif_m), dif_m))) / math.sum(math.diag(math.multiply(math.transpose(Z), Z)));
                let Fit_s = 1 - math.sum(math.diag(math.multiply(math.transpose(dif_s), dif_s))) / math.sum(math.diag(math.multiply(math.transpose(Gamma), Gamma)));

                let Afit = 1 - ((1 - Fit) * (DF) / (DF - NPAR));
                this.output.modelfit = this.modelFit(Z, this.output.RESULT.W, A, number_of_variables, number_of_latent_vars, number_of_groups, case_index);
                let Gfi = this.output.modelfit.GFI;
                let Srmr = this.output.modelfit.SRMR;
                let COR_RES = this.output.modelfit.COR_RES;

                let total_s = jStat.zeros(number_of_groups * number_of_latent_vars, number_of_latent_vars);
                let indirect_s = jStat.zeros(number_of_groups * number_of_latent_vars, number_of_latent_vars);
                let total_m = jStat.zeros(number_of_groups * number_of_latent_vars, number_of_variables);
                let indirect_m = jStat.zeros(number_of_groups * number_of_latent_vars, number_of_variables);
                var k = kk = -1;
                for (let g = 0; g < number_of_groups; g++) {
                    k = kk + 1;
                    kk += number_of_latent_vars;
                    let B = jStat.col(BR, jStat.arange(k, kk + 1));
                    let C = jStat.col(CR, jStat.arange(k, kk + 1))
                    this.output.effects = this.effects(B, C);
                    let te_s = this.output.effects.te_s;
                    let te_m = this.output.effects.te_m;
                    let ie_s = this.output.effects.ie_s;
                    let ie_m = this.output.effects.ie_m;
                    total_s = math.subset(total_s, math.index(math.range(k, kk + 1), math.range(0, number_of_latent_vars)), te_s);
                    indirect_s = math.subset(indirect_s, math.index(math.range(k, kk + 1), math.range(0, number_of_latent_vars)), ie_s);
                    total_m = math.subset(total_m, math.index(math.range(k, kk + 1), math.range(0, number_of_variables)), te_m);
                    indirect_m = math.subset(indirect_m, math.index(math.range(k, kk + 1), math.range(0, number_of_variables)), ie_m);

                }
                if (b === 0) {
                    if (this.moption === 2) {
                        console.log("Missing value")
                    } else if (this.moption === 3) {

                    }

                    if (it <= this.itmax) {
                        if (imp <= this.ceps) {
                            console.log(`The algorithm converged in ${it} iterations (convergence criterion = ${this.ceps})`)
                        } else {
                            console.log(`The algorithm FAILED to convergence in ${it} iterations (convergence criterion = ${this.ceps})`)
                        }
                    }
                    WR = JSON.parse(JSON.stringify(W));
                    Cr = JSON.parse(JSON.stringify(CR));
                    Br = JSON.parse(JSON.stringify(BR));
                    samplesizes = number_of_observation_per_group;
                    FIT = JSON.parse(JSON.stringify(Fit));
                    FIT_M = JSON.parse(JSON.stringify(Fit_m));
                    FIT_S = JSON.parse(JSON.stringify(Fit_s));
                    AFIT = JSON.parse(JSON.stringify(Afit));
                    GFI = JSON.parse(JSON.stringify(Gfi));
                    SRMR = JSON.parse(JSON.stringify(Srmr));

                    R2 = jStat.zeros(number_of_groups, number_of_latent_vars);
                    AVE = jStat.zeros(number_of_groups, number_of_latent_vars);
                    Alpha = jStat.zeros(number_of_groups, number_of_latent_vars);
                    rho = jStat.zeros(number_of_groups, number_of_latent_vars);
                    Dimension = jStat.zeros(number_of_groups, number_of_latent_vars);
                    let lvmean = jStat.zeros(number_of_groups, number_of_latent_vars);
                    let lvvar = jStat.zeros(number_of_groups, number_of_latent_vars);
                    corr_corres = jStat.zeros(number_of_groups * number_of_variables, number_of_variables);

                    let ss = -1;
                    let kk = -1;
                    let z0_g;
                    for (let g = 0; g < number_of_groups; g++) {
                        let s = ss + 1;
                        let k = kk + 1;
                        ss = ss + number_of_latent_vars;
                        kk += number_of_variables;
                        if (this.moption === 3) {

                        } else {
                            z0_g = jStat.row(this.z0, jStat.arange(case_index[g][0], case_index[g][1] + 1))
                        }
                        let W_g = math.subset(W, math.index(math.range(k, kk + 1), math.range(s, ss + 1)));
                        let CF_g = math.subset(corF, math.index(math.range(s, ss + 1), math.range(s, ss + 1)));
                        let B = math.transpose(jStat.col(BR, jStat.arange(s, ss + 1)));
                        let stdL = jStat.col(CR, jStat.arange(s, ss + 1));
                        for (let j = 0; j < number_of_latent_vars; j++) {
                            let _val = math.multiply(math.transpose(jStat.col(B, j)), jStat.col(CF_g, j));
                            R2[g][j] = _val[0][0];
                            let zind = [];
                            math.flatten(math.transpose(jStat.col(this.W00, j))).forEach((d, i) => {
                                if (d !== 0) zind.push(i);
                            })
                            let nnzload = zind.length;
                            if (nnzload > 0) {
                                let sumload = jStat.sum(math.flatten(jStat.pow(math.subset(stdL, math.index(zind, j)), 2)));
                                let sumload_rho1 = math.pow(jStat.sum(math.flatten(math.subset(stdL, math.index(zind, j)))), 2);
                                let sumload_rho2 = math.sum(math.subtract(1, jStat.pow(math.flatten(math.subset(stdL, math.index(zind, j))), 2)));
                                AVE[g][j] = sumload / nnzload;
                                rho[g][j] = sumload_rho1 / (sumload_rho1 + sumload_rho2);
                            }
                            let nzj = zind.length;
                            if (nzj > 1) {
                                let zsubset = jStat.col(z0_g, zind);
                                Alpha[g][j] = this.cronbachalpha(zsubset);
                                let eigs = math.eigs(this.correlationMat(zsubset)).values;
                                Dimension[g][j] = eigs.filter(d => d > 1).length;
                            } else {
                                Alpha[g][j] = 1;
                            }

                        }
                        //Calculate latent scores
                        let lvscore_g = this.lvscore(z0_g, W_g);
                        jStat(lvscore_g).mean().map((d, i) => {
                            lvmean[g][i] = d;
                        })
                        jStat(lvscore_g).variance().map((d, i) => {
                            lvvar[g][i] = d;
                        })
                        let sample_corr = this.correlationMat(z0_g);
                        //Update Corr_res
                        for (let r = k; r < kk + 1; r++) {
                            for (let c = 0; c < number_of_variables; c++) {
                                if (r === c) continue;
                                if (r < c) {
                                    corr_corres[r][c] = COR_RES[r][c];
                                } else {
                                    corr_corres[r][c] = sample_corr[r][c];
                                }
                            }
                        }
                    }
                    LV_MEAN = JSON.parse(JSON.stringify(lvmean));
                    LV_VAR = JSON.parse(JSON.stringify(lvvar));
                   
                    latencorr = corF;
                    TE_S = total_s;
                    ID_S = indirect_s;
                    TE_M = total_m;
                    ID_M = indirect_m;

                    ////

                } else { //Bootstrap sample solution

                    let vecw = [];
                    math.flatten(math.transpose(W)).forEach(d => {
                        if (d !== 0) vecw.push(d);
                    });
                    let vecload = [];
                    math.flatten(math.transpose(CR)).forEach(d => {
                        if (d !== 0) vecload.push(d);
                    });
                    let vecbeta = [];
                    math.flatten(math.transpose(BR)).forEach(d => {
                        if (d !== 0) vecbeta.push(d);
                    });
                    let veccorF = [];
                    math.flatten(math.transpose(corF)).forEach(d => {
                        if (d !== 0) veccorF.push(d);
                    });

                    vec_FIT[b - 1] = Fit;
                    vec_FIT_m[b - 1] = Fit_m;
                    vec_FIT_s[b - 1] = Fit_s;
                    vec_AFIT[b - 1] = Afit;
                    vec_GFI[b - 1] = Gfi;
                    vec_SRMR[b - 1] = Srmr;

                    vecw.map((d, i) => {
                        MatW[b - 1][i] = d;
                    })
                    vecload.map((d, i) => {
                        Matload[b - 1][i] = d;
                    })
                    vecbeta.map((d, i) => {
                        Matbeta[b - 1][i] = d;
                    })
                    vecload.map((d, i) => {
                        Matsmc[b - 1][i] = d * d;
                    });
                    veccorF.map((d, i) => {
                        MatcorF[b - 1][i] = d;
                    });
                    let _temptt_s = [];
                    math.flatten(math.transpose(total_s)).forEach(d => {
                        if (d !== 0) _temptt_s.push(d);
                    })
                    MatTE_S.push(_temptt_s);

                    let _indirect_s = [];
                    math.flatten(math.transpose(indirect_s)).forEach(d => {
                        if (d !== 0) _indirect_s.push(d);
                    })
                    MatID_S.push(_indirect_s);

                    let _total_m = [];
                    math.flatten(math.transpose(total_m)).forEach(d => {
                        if (d !== 0) _total_m.push(d);
                    })
                    MatTE_M.push(_total_m);

                    let _indirect_m = [];
                    math.flatten(math.transpose(indirect_m)).forEach(d => {
                        if (d !== 0) _indirect_m.push(d);
                    })
                    MatID_M.push(_indirect_m);

                }


            }

            lb = math.ceil(this.nbt * 0.025);
            ub = math.ceil(this.nbt * 0.975);
            let sortFIT = vec_FIT.sort((a, b) => a - b);
            let sortFIT_m = vec_FIT_m.sort((a, b) => a - b);
            let sortFIT_s = vec_FIT_s.sort((a, b) => a - b);
            let sortAFIT = vec_AFIT.sort((a, b) => a - b);
            let sortGFI = vec_GFI.sort((a, b) => a - b);
            let sortSRMR = vec_SRMR.sort((a, b) => a - b);
            let sortw = math.transpose(math.transpose(MatW).map(d => d.sort()));
            let sortload = math.transpose(math.transpose(Matload).map(d => d.sort()));
            let sortbeta = math.transpose(math.transpose(Matbeta).map(d => d.sort()));
            let sortsmc = math.transpose(math.transpose(Matsmc).map(d => d.sort()));
            let sortcorF = math.transpose(math.transpose(MatcorF).map(d => d.sort()));
            let sortte_s = math.transpose(math.transpose(MatTE_S).map(d => d.sort()));
            let sortid_s = math.transpose(math.transpose(MatID_S).map(d => d.sort()));
            let sortte_m = math.transpose(math.transpose(MatTE_M).map(d => d.sort()));
            let sortid_m = math.transpose(math.transpose(MatID_M).map(d => d.sort()));

            return {
                sortAFIT,
                sortbeta,
                sortcorF,
                sortFIT,
                sortFIT_m,
                sortFIT_s,
                sortGFI,
                sortid_m,
                sortid_s,
                sortload,
                sortw,
                sortSRMR,
                sortsmc,
                sortte_m,
                sortte_s,
                WR,
                Cr,
                Br,
                samplesizes,
                FIT,
                FIT_M,
                FIT_S,
                AFIT,
                GFI,
                SRMR,
                R2,
                AVE,
                Alpha,
                rho,
                LV_MEAN,
                LV_VAR,
                corr_corres,
                Dimension,
                latencorr,
                lb,
                ub,
                vec_SRMR,
                vec_GFI,
                vec_AFIT,
                vec_FIT_s,
                vec_FIT_m,
                vec_FIT
            }


        }

        lvscore(X, W, option = 1) {
            let nobs = jStat.rows(X);
            let nlv = jStat.cols(W);
            let ctz = math.subtract(X, math.multiply(math.ones(nobs, 1), [math.mean(X, 0)]))._data;
            let covz = math.divide(math.multiply(math.transpose(ctz), ctz), nobs);
            let Dstz = math.sqrt(math.diag(math.diag(covz)));
            let UstdW = math.multiply(math.inv(Dstz), W);
            let lvscore;
            if (option === 1) {
                let sumUstdW = jStat(UstdW).sum();
                let rUstdW = JSON.parse(JSON.stringify(UstdW));
                for (let j = 0; j < nlv; j++) {
                    let _val = math.flatten(math.divide(math.subset(UstdW, math.index(math.range(0, jStat.rows(UstdW)), j)), sumUstdW[j]));
                    _val.map((d, i) => {
                        rUstdW[i][j] = d;
                    })
                }
                lvscore = math.multiply(X, rUstdW);

            } else if (option === 2) {
                lvscore = math.multiply(X, UstdW);
            }
            return lvscore;

        }

        cronbachalpha(X) {
            let nvar = jStat.cols(X);
            let crX = this.correlationMat(X);
            let rows = jStat.rows(crX);
            let cols = jStat.cols(crX);
            let sumcorr = 0;
            for (let r = 0; r < rows; r++) {
                for (let c = r + 1; c < cols; c++) {
                    sumcorr += crX[r][c];
                }
            }
            return nvar * sumcorr / (0.5 * nvar * (nvar - 1) + (nvar - 1) * sumcorr)


        }

        effects(B, C) {
            //Calculate the total and indirect effects in measurement and structural model
            let nlv = jStat.rows(B);
            let te_s = math.transpose(math.subtract(math.inv(math.subtract(math.identity(nlv), B)), math.identity(nlv)));
            let ie_s = math.subtract(te_s, math.transpose(B));
            let te_m = math.transpose(math.transpose(math.multiply(math.inv(math.transpose(math.subtract(math.identity(nlv), B))), math.transpose(C))))
            let ie_m = math.subtract(te_m, math.transpose(C));
            return {te_s: te_s._data, ie_s: ie_s._data, te_m: te_m._data, ie_m: ie_m._data}
        }

        modelFit(Z0, W, T, nvar, nlv, ng, case_index) {
            let GFI, SRMR, COR_RES;
            let obs = jStat.rows(Z0);

            let gfi_1 = 0;
            let gfi_2 = 0;
            let srmr_1 = 0;
            let kk = -1;
            let ss = -1;
            for (let g = 0; g < ng; g++) {
                let k = kk + 1;
                kk += nvar;
                let s = ss + 1;
                ss += nlv;
                let zz = math.subset(Z0, math.index(math.range(case_index[g][0], case_index[g][1] + 1), math.range(k, kk + 1)));
                let w = math.subset(W, math.index(math.range(k, kk + 1), math.range(s, ss + 1)));
                let v = math.concat(math.identity(nvar), w)._data;
                let t = jStat.row(T, jStat.arange(s, ss + 1));
                let omega = math.subtract(v, math.multiply(w, t));
                let ee = math.multiply(zz, omega);
                let samcov = math.divide(math.multiply(math.transpose(math.subtract(zz, math.divide(math.multiply(math.ones(obs, obs), zz), obs))), math.subtract(zz, math.divide(math.multiply(math.ones(obs, obs), zz), obs))), (obs - 1))._data;
                let samcor = this.correlationMat(zz);
                let tp_precov = math.multiply(math.inv(math.multiply(omega, math.transpose(omega))), math.multiply(omega, math.diag(jStat(ee).variance()), math.transpose(omega)))
                let precov = math.transpose(math.multiply(math.inv(math.transpose(math.multiply(omega, math.transpose(omega)))), math.transpose(tp_precov)))
                let COV_RES = math.subtract(samcov, precov);
                let prerij = JSON.parse(JSON.stringify(precov));
                for (let i = 0; i < nvar; i++) {
                    for (let j = 0; j < nvar; j++) {
                        prerij[i][j] = precov[i][j] / math.sqrt(precov[i][i] * precov[j][j]);
                    }
                }
                let srmr = 0;
                for (let i = 0; i < nvar; i++) {
                    for (let j = 0; j < nvar; j++) {
                        if (j > i) {
                            let corr_residual = math.pow(samcor[i][j] - prerij[i][j], 2);
                            srmr = srmr + corr_residual;
                        }
                    }
                }

                srmr_1 += srmr;
                gfi_1 += math.sum(math.diag(math.pow(COV_RES, 2)));
                gfi_2 += math.sum(math.diag(math.pow(samcov, 2)));

                COR_RES = math.subtract(samcor, prerij);

            }
            let nvar_tot = ng * nvar;
            let srmr_2 = nvar_tot * (nvar_tot + 1) / 2;
            SRMR = math.sqrt(srmr_1 / srmr_2);
            GFI = 1 - (gfi_1 / gfi_2);

            return {GFI, SRMR, COR_RES}
        }

        correlationMat(data) {
            let nrow = jStat.rows(data);
            let C = math.subtract(math.identity(nrow), math.divide(math.ones(nrow, nrow), nrow));
            let D = math.diag(jStat(data).stdev());
            let Xs = math.multiply(C, data, math.inv(D))
            return math.divide(math.multiply(math.transpose(Xs), Xs), nrow)._data;
        }

        findIndex(data, val) {
            let ret = [];
            math.flatten(math.transpose(data)).forEach((d, i) => {
                if (d >= val) {
                    ret.push(i);
                }
            })
            return ret;
        }

        alternativeLeastSquareAlgorithm(Z, W0, A0, W, A, V, I, PHT, nvar, nlv, ng, itmax, ceps) {

            let numberOfColumnsA = math.matrix(A).size()[1];
            let numberOfRowsA = math.matrix(A).size()[0];
            let aindex0 = [];


            math.flatten(math.transpose(A0)).forEach((d, i) => {
                if (d >= 1) aindex0.push(i)
            });
            let Psi = math.multiply(Z, V, I);
            let Gamma = math.multiply(Z, W);
            let it = 0;
            let imp = 100000;
            let f0 = math.pow(10, 10);
            while (it <= itmax && imp > ceps) {
                it += 1;

                //Update A
                for (let t = 0; t < numberOfColumnsA; t++) {
                    if (math.sum(math.flatten(jStat.col(A0, t))) !== 0) {
                        let H1 = jStat.identity(numberOfColumnsA);
                        H1[t][t] = 0;
                        let aindex = [];
                        math.flatten(jStat.col(A0, t)).forEach((d, i) => {
                            if (d >= 1) aindex.push(i);
                        })
                        if (aindex.length > 0) {
                            let a = jStat.col(A, t);
                            aindex.map(d => {
                                a[d][0] = 0;
                            })
                            let e = jStat.zeros(1, numberOfColumnsA);
                            e[0][t] = 1;
                            let Y = math.subtract(Psi, math.multiply(Gamma, math.add(math.multiply(A, H1), math.multiply(a, e))))
                            let X = jStat.col(Gamma, aindex);
                            let _val = math.multiply(math.inv(math.multiply(math.transpose(X), X)), math.multiply(math.transpose(X), Y, math.transpose(e)));
                            aindex.forEach((ai, i) => {
                                A[ai][t] = _val[0][i];
                            })
                        }
                    }
                }

                let vecA = this.extractValFromIndex(A, aindex0);
                let _tempAA = math.flatten(math.transpose(A));
                aindex0.forEach((d, i) => {
                    _tempAA[d] = vecA[i];
                })
                A = math.transpose(math.reshape(_tempAA, [numberOfColumnsA, numberOfRowsA]));


                let kk = -1;
                for (let g = 0; g < ng; g++) {
                    let k = kk + 1;
                    kk = kk + nlv;
                    let p = (g + 1) * nvar + g * nlv;
                    let s = -1;
                    for (let j = k; j <= kk; j++) {
                        s = s + 1;
                        let windex = [];
                        math.flatten(jStat.col(W0, j)).forEach((d, i) => {
                            if (d === 99) windex.push(i);
                        })
                        let w = jStat.col(W, j);
                        windex.map(d => {
                            w[d][0] = 0;
                        });

                        let beta = [math.subtract(jStat.row(I, p + s), jStat.row(A, j))];//1D array
                        let H2 = jStat.identity(ng * nlv);
                        H2[j][j] = 0;
                        let H3 = jStat.identity(numberOfColumnsA * ng);
                        H3[p + s][p + s] = 0;
                        let AA1 = math.multiply(W, H2, A);
                        let AA2 = math.multiply(V, H3, I);
                        let AA3 = math.multiply(w, beta);
                        let Delta = math.subtract(math.subtract(AA1, AA2), AA3);
                        let Zp = jStat.col(Z, windex);
                        let temptheta = math.multiply(math.multiply(math.inv(math.multiply(math.transpose(Zp), Zp)), math.transpose(Zp)), math.multiply(Z, Delta), math.transpose(beta))
                        let theta = math.transpose(math.multiply(math.inv(math.transpose(math.multiply(beta, math.transpose(beta)))), math.transpose(temptheta)))
                        let zw = math.multiply(Zp, theta);
                        theta = math.multiply(theta, math.inv(math.sqrt(math.multiply(math.transpose(zw), zw))));
                        windex.map((d, i) => {
                            W[d][j] = theta[i][0];
                            V[d][p + s] = theta[i][0];
                        })
                    }
                }
                Gamma = math.multiply(Z, W);
                Psi = math.multiply(Z, V);
                let dif = math.subtract(Psi, math.multiply(Gamma, A));
                let f = math.trace(math.multiply(math.transpose(dif), dif));
                imp = f0 - f;
                f0 = f;
            }
            return {W, A, Psi, Gamma, f0, it, imp}
        }

        updateMatrixFromIndex(data, indexes, values) {
            let dim = jStat(data).dimensions();
            let _data = math.flatten(math.transpose(data));
            indexes.forEach((d, i) => {
                _data[d] = values[i];
            })
            _data = math.transpose(math.reshape(_data, [dim.cols, dim.rows]));
            return _data;

        }

        extractValFromIndex(data, IndexArr) {
            let ret = [];
            let A00 = math.flatten(math.transpose(data));
            IndexArr.forEach(d => {
                ret.push(A00[d])
            })
            return ret;
        }

        extractFromArray(data, from, to) {
            let ret = [];
            for (let i = from; i <= to; i++) {
                ret.push(data[i]);
            }
            return ret;
        }

        bootsample(z0, case_index, number_of_variables, number_of_observation_per_group, number_of_groups, b, number_of_observations) {
            let Z = jStat.zeros(number_of_observations, number_of_groups * number_of_variables);
            let bz01;
            let kk = -1;
            for (let g = 0; g < number_of_groups; g++) {
                let k = kk + 1;
                kk += number_of_variables;
                if (b === 0) {
                    bz01 = this.extractFromArray(z0, case_index[g][0], case_index[g][1])
                } else {
                    let rrb = math.ceil(math.multiply(math.random([1, number_of_observations]), number_of_observations - 1))[0];
                    bz01 = jStat.zeros(number_of_observation_per_group[g], number_of_variables);
                    let z0_g = jStat.row(z0, jStat.arange(case_index[g][0], case_index[g][1] + 1));
                    for (let i = 0; i < number_of_observation_per_group[g]; i++) {
                        bz01[i] = JSON.parse(JSON.stringify(z0_g[rrb[i]]))

                        // math.subset(bz01,math.index(i, math.range(0,number_of_variables)), math.subset(z0_g,math.index(rrb[0][i], math.range(0, number_of_variables))) );
                    }
                }
                let _z0mean = [jStat(z0).mean()];
                let _identity = jStat.ones(number_of_observation_per_group[g], 1);
                let _product = math.multiply(_identity, _z0mean);
                let ctz = math.subtract(bz01, _product);
                let covz = math.divide(math.multiply(math.transpose(ctz), ctz), number_of_observation_per_group[g]);
                let Dstz = math.sqrt(math.diag(math.diag(covz)));
                let bz0 = math.divide(ctz, Dstz);
                bz0 = math.divide(bz0, math.sqrt(number_of_observation_per_group[g]));
                Z = this.cloneArray(bz0, Z, case_index[g][0], k);


            }
            return {Z};
        }

        cloneArray(source, target, Rstart, Cstart) {
            let dim = jStat(source).dimensions();
            let rows = dim.rows, cols = dim.cols;
            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    let val = source[i][j];
                    target[i + Rstart][j + Cstart] = val;
                }
            }
            return target;
        }

        create1Darray(num, val) {
            let ret = [];
            for (let i = 0; i < num; i++) {
                ret.push(val)
            }
            return ret;
        }

        generateConstraintMatrix(A0) {
            let PHT, num_const;
            let dim = jStat(A0).dimensions();
            let vector0 = math.flatten(math.transpose(A0));
            let vect = [];
            let nzct = [];
            vector0.forEach((d, i) => {
                if (d >= 1) {
                    vect.push(d)
                    nzct.push(i);
                }
            })
            let nzt = nzct.length;
            let nzcst = [];
            let num_nzct = nzcst.length;
            if (num_nzct === 0) {
                PHT = jStat.identity(nzt);
                num_const = 0;
            } else {

            }
            return {PHT, num_nzct, num_const}
        }
    }

    $(document).ready(function () {
        // Copy to clipboard function
        let clipboardCopy = document.getElementById("clipboardCopy");
        clipboardCopy.addEventListener("click", copyToClipBoard, false);

        function copyToClipBoard() {
            let copyText = document.getElementById("sampleModel");
            if (document.selection) {
                let range = document.body.createTextRange();
                range.moveToElementText(copyText);
                range.select().createTextRange();
                document.execCommand("copy");
            } else if (window.getSelection) {
                let range = document.createRange();
                range.selectNode(copyText);
                window.getSelection().addRange(range);
                document.execCommand("copy");
            }
        }

        // Init data container
        let dataTable = new DataTablePrep();
        // Init Gesca
        let gesCa = new GESCA();
        // Process File Upload
        let uploader = document.getElementById("uploader");
        uploader.addEventListener('change', fileUpload, false);

        function fileUpload(event) {
            let reader = new FileReader();
            let file = this.files[0];
            reader.readAsText(file);
            reader.onprogress = function (_data) {
                if (_data.lengthComputable) {
                    let percent = Math.round((_data.loaded / _data.total) * 100);
                    $("#progressPrep").css("width", percent + '%');
                }

            };
            reader.onloadend = function () {
                let contents = reader.result;
                let data = d3.csv.parse(contents);
                dataTable.init(data).populateData().display();
            };
        }


        // Analyze the model
        let btnAnalyzeModel = document.getElementById('btnAnalyzeModel');
        btnAnalyzeModel.addEventListener('click', analyzeModel, false);

        function analyzeModel() {
            let textModel = $('#myModel').val().replace(/ /g, '');
            if (dataTable.jsonData == null || textModel === '') {
                alert("Please upload your data or specify the model");
            } else {
                // params = z0, group_var, W00, C00, B00,
                //                      loadtype = matrix(1,1,ncol(W00)), nbt = 100, itmax = 100,
                // ceps = 0.00001, moption = 0, missingvalue = NULL
                let result = dataTable.parseData(textModel).result;
                let loadtype = [];
                let cols = jStat(result.W00).dimensions().cols
                for (let i = 0; i < cols; i++) {
                    loadtype.push(1);
                }
                let params = {
                    z0: result.data,
                    group_var: null,
                    W00: result.W00, //weight matrix
                    C00: result.C00,//component matrix
                    B00: result.B00,//latent matrix
                    loadtype: loadtype,
                    nbt: 100, //number of bootstrap
                    itmax: 100, //max iteration
                    ceps: 0.00001, //min threshold value
                    moption: 0, //process missing values: 0-no missing, 1-listwise deletion, 2 - row wise deletion
                    missingvalue: null
                }
                let displayRet = gesCa.init(params).modelAnalyzer();
                console.log(displayRet)
            }
        }

    });


</script>
</html>